<html>
	<head>
		<style type="text/css">
			* {
				font-family:monospace;
			}
			html,body {
				background: #272F87;
				height:100%;
				color:white;
				font-family:Arial,Helvetica,sans-serif;
				font-size:12px;
			}
			
			body {
				margin:0;
				padding:10;
			}
			
			td {
				padding:2px;
				padding-left:6px;
				padding-right:6px;
				margin:0;
				border-bottom:2px solid darkblue;
			}
			
			td.head {
				border-bottom:2px solid white;
			}
		</style>
        <title>bitHopper info</title>
		<script type="text/javascript" src="http://code.jquery.com/jquery-1.6.2.min.js"></script>
		<script type="text/javascript" src="http://omnipotent.net/jquery.sparkline/1.6/jquery.sparkline.min.js"></script>
		<script type="text/javascript">
		
			function getName(payload, srv) {
				return srv['name'];
			}
			
			function getColor(payload, srv) {
				if(payload['servers'][payload['current']]['name'] == srv['name']) {
					return 'yellow';
				}
					
				if(srv['lag'] == true) {
					return 'red';
				}
					
				return undefined;
			}
			
			function getShares(payload, srv) {
				shares = srv['shares'];
				if(srv["role"] != "mine" && srv["role"] != "mine_nmc" && srv["role"] != "info" && srv["role"] != "mine_slush") {
					return "N/A";
				}
				
				return shares
					+ "<br>"
					+ fixLength((shares / payload['difficulty'] * 100).toFixed(2), 6)
					+ "%";
			}
			
			function getRole(payload, srv) {
				return srv["role"];
			}
			
			function getUserShareRejects(payload, srv) {
				var pp = 0;
				if(srv["rejects"] > 0) {
					pp = parseFloat(parseFloat(srv["rejects"])) / parseFloat(srv["user_shares"]) * 100;
				}
				return srv["user_shares"]
					+ "&nbsp;/&nbsp;"
					+ srv["rejects"]
					+ "<br>"
					+ fixLength("" + pp.toFixed(2), 5);
			}
			
			function getPayout(payload, srv) {
				return srv["payout"];
			}
			
			function getEfficiency(payload, srv) {
				var payout = srv["payout"]
				var expect = (parseFloat(srv["user_shares"])*50)/payload["difficulty"];
				expect  = parseFloat((parseFloat(payout)/expect) * 100).toFixed(1);
				var pay_str = expect +  "%";
				if (isNaN(expect)) {
					pay_str = "&nbsp;";
				}
				return pay_str;
			}
			
			function getRoundShares(payload, srv) {
				if(srv["role"] != "mine" && srv["role"] != "info")
					return [];
					
				return srvhist[srv['name']];
			}
			
			var srvhist = {};
			function updateRoundShares(data) {
				for(v in data["servers"]) {
					var d = data["servers"][v]["shares"];
					if(srvhist[data["servers"][v]['name']] == undefined) {
						srvhist[data["servers"][v]['name']] = [ d ];
					} else {
						srvhist[data["servers"][v]['name']].push(d);
					}
				}
			}
			
			function buildTable(id, items, payload, columns, fnSort) {
				var html = "";
				html += "<table width=100% border=0 padding=0 cellpadding=0 cellspacing=0>";
				html += "	<tr>";
				
				for(col in columns) {
					var column = columns[col];
					var tdAttr = "";

					if(column['width'] != undefined) {
						cssAttr += "width:" + column['width'];
					}
					
					if(column['align'] != undefined)
						tdAttr += " align='" + column['align'] + "'";
					
					html += "	<td class='head' " + tdAttr + "><b>" + col.replace(/\s/g, "&nbsp;") + "</b></td>";
				}
				
				html += "	</tr>";
				
				var rows = [];
				for(row in items) {
					rows.push(row);
				}
				if(fnSort != undefined) {
					row = rows.sort(fnSort);
				}
				var chartBuildUps = [];

				for(var i=0;i<rows.length;i++) {
					var r = rows[i];
					var row = items[r];
					html += "<tr>";
					
					for(col in columns) {
						var column = columns[col];
						var tdAttr = "";
						var cssAttr = "";
						
						if(column['align'] != undefined) {
							tdAttr += " align='" + column['align'] + "'";
						}
						
						if(column['width'] != undefined) {
							cssAttr += "width:" + column['width'] + ";";
						}
						
						if(column['color'] != undefined) {
							var color = column['color'](payload, row);
							if(color != undefined) {
								cssAttr += "color:" + color + ";";
							}
						}
						
						var content = "";
						var data = column['data'](payload, row);
						
						if(column['type'] == undefined) {
							content = data;
						} else if(column['type'] == 'linechart') {
							content = "<span id='chart" + chartBuildUps.length + "' style='width:100%;'></span>";
							chartBuildUps.push( { 'data':data } );
							cssAttr += "padding:0px;";
							tdAttr += " width='100%'";
						}
						
						html += "<td " + tdAttr + " style='" + cssAttr + "'>" + content + "</td>";
					}
					
					html += "</tr>";
				}
				
				html += "</table>";
				$(id).html(html);
				
				for(var i=0; i < chartBuildUps.length; i++) {
					$("#chart" + i).sparkline(chartBuildUps[i]['data'], { type:'line', 'lineColor':'white', 'fillColor':false,'composite':true, 'spotColor':false, 'lineWidth':2 ,'spotRadius':0, 'width':'100%'} );							
				}
			}
		
			function fixLength(t, l) {
				while(t.length < l) {
					t = "&nbsp;" + t;
				}
				return t;
			}
		
			function update() {
				$.getJSON('/data', function(data) {
					$("#current").html("<span style='color:yellow;'>" + data["current"] + "</span> @" + parseInt(data["mhash"]) + "MHash");

					updateRoundShares(data);

					buildTable("#table", data['servers'], data,
						{
							'Server': { 'data':getName, 'color':getColor },
							'Shares': { 'data':getShares, 'align':'right' },
							'Role': { 'data':getRole },
							'User Shares / Rejects': { 'data':getUserShareRejects, 'align':'right' },
							'Payout': { 'data':getPayout, 'align':'right' },
							'Efficiency': { 'data':getEfficiency, 'align':'right' },
							'Round Shares': { 'data':getRoundShares, 'type':'linechart', 'width':'100%' }
						},
						function(a, b) {
							if(data["servers"][a]["role"].trim() != data["servers"][b]["role"].trim()) {
								return data["servers"][a]["role"] > data["servers"][b]["role"];
							}
							
							return data["servers"][a]["name"] > data["servers"][b]["name"]
						}
					);
				});
			}
			
			$(document).ready(function() {
				setInterval("update()", 5000);
				update();
			});
		</script>
	</head>
	<body>
		<h1 id="current"></h1>
		<div id="table"></div>
	</body>
</html>
